name: Tauri Build & Release

on:
    push:
        branches:
            - main
        tags:
            - 'v*'
    pull_request:
        branches:
            - main
    workflow_dispatch:

# é»˜è®¤åªè¯»æƒé™
permissions:
    contents: read

jobs:
    # =========================
    # 1ï¸âƒ£ Build Jobï¼ˆä¸å‘å¸ƒï¼‰
    # =========================
    build:
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: macos-latest
                      target: aarch64-apple-darwin
                      name: macOS-AppleSilicon

                    - platform: macos-latest
                      target: x86_64-apple-darwin
                      name: macOS-Intel

                    - platform: ubuntu-22.04
                      target: x86_64-unknown-linux-gnu
                      name: Linux

                    - platform: windows-latest
                      target: x86_64-pc-windows-msvc
                      name: Windows

        runs-on: ${{ matrix.platform }}
        name: Build ${{ matrix.name }}

        steps:
            - uses: actions/checkout@v4

            # Linux ä¾èµ–
            - name: Install Linux dependencies
              if: matrix.platform == 'ubuntu-22.04'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    libwebkit2gtk-4.1-dev \
                    libgtk-3-dev \
                    libayatana-appindicator3-dev \
                    librsvg2-dev

            - uses: actions/setup-node@v4
              with:
                  node-version: 20

            - uses: pnpm/action-setup@v3
              with:
                  version: 9

            - uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - uses: swatinem/rust-cache@v2
              with:
                  workspaces: './src-tauri -> target'

            - name: Install frontend deps
              run: pnpm install

            # ğŸ”¹ åªæ„å»ºï¼Œä¸åˆ›å»º release
            - name: Build Tauri App
              uses: tauri-apps/tauri-action@v0
              with:
                  target: ${{ matrix.target }}
                  releaseDraft: false
                  prerelease: false
                  args: ${{ matrix.platform == 'ubuntu-22.04' && '--bundles appimage,deb' || '' }}

            # ä¸Šä¼  artifactsï¼ˆä¾› release job ä½¿ç”¨ï¼‰
            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.name }}
                  path: src-tauri/target/${{ matrix.target }}/release/bundle/**
                  retention-days: 7

    # =========================
    # 2ï¸âƒ£ Release Jobï¼ˆåªåœ¨ tag è§¦å‘ï¼‰
    # =========================
    release:
        needs: build
        if: startsWith(github.ref, 'refs/tags/v')
        runs-on: ubuntu-latest

        # åªæœ‰è¿™é‡Œæœ‰å†™æƒé™
        permissions:
            contents: write

        steps:
            - uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Show artifacts
              run: ls -R artifacts

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ github.ref_name }}
                  name: PM ${{ github.ref_name }}
                  draft: false
                  generate_release_notes: true
                  files: artifacts/**/*
